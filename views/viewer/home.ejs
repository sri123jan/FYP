<% if (!user) { %>
	<p>Welcome! Please <a href="/login">log in</a>.</p>
<% } else { %>
	<!DOCTYPE html>
<html lang="en">
   
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <meta name="description" content="Askbootstrap">
      <meta name="author" content="Askbootstrap">
      <title>VIDOE - Video Streaming Website HTML Template</title>
      <!-- Favicon Icon -->
      <link rel="icon" type="image/png" href="/assets/img/favicon.png">
      <!-- Bootstrap core CSS-->
      <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
      <!-- Custom fonts for this template-->
      <link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
      <!-- Custom styles for this template-->
      <link href="/assets/css/osahan.css" rel="stylesheet">
      <link href="/assets/css/style.css" rel="stylesheet">
      <!-- Owl Carousel -->
      <link rel="stylesheet" href="/assets/vendor/owl-carousel/owl.carousel.css">
      <link rel="stylesheet" href="/assets/vendor/owl-carousel/owl.theme.css">
      <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
   </head>
   <body id="page-top">
      <%- include ('partials/navbar.ejs') %>
      <div id="wrapper">
         <!-- Sidebar -->
         <ul class="sidebar navbar-nav">
            <li class="nav-item active">
               <a class="nav-link" href="/">
               <i class="fas fa-fw fa-home"></i>
               <span>Home</span>
               </a>
            </li>
            <li class="nav-item">
               <a class="nav-link" href="/channels">
               <i class="fas fa-fw fa-users"></i>
               <span>Subscriptions</span>
               </a>
            </li>
            <li class="nav-item">
               <a class="nav-link" href="/account">
               <i class="fas fa-fw fa-user"></i>
               <span>My Account</span>
               </a>
            </li>
            
            <li class="nav-item channel-sidebar-list">
               <h6>SUBSCRIPTIONS</h6>
               <ul> 
                  <% for( let i = 0; i < subscribersList.length; i++ ) { %>
                     <li>
                        <a href="/individual/<%= subscribersList[i].channel %>">
                           <img class="img-fluid" alt="" src="/assets/img/s1.png">
                           <%= subscribersList[i].channel %>  
                        </a>
                     </li>
                  <% } %>
               </ul>
            </li>
         </ul>

         <div id="content-wrapper">
            <div class="container-fluid pb-0">
               <div class="top-mobile-search">
                  <div class="row">
                     <div class="col-md-12">   
                        <form class="mobile-search">
                           <div class="input-group">
                             <input type="text" placeholder="Search for..." class="form-control">
                               <div class="input-group-append">
                                 <button type="button" class="btn btn-dark"><i class="fas fa-search"></i></button>
                               </div>
                           </div>
                        </form>   
                     </div>
                  </div>
               </div>
               <div class="top-category section-padding mb-4">
                  <% if(liveStreamer.length > 0){ %>
                     <div class="row">
                        <div class="col-md-12">
                           <div class="main-title">
                              <div class="btn-group float-right right-action">
                                 <a href="#" class="right-action-link text-gray" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                 <i class="fa fa-ellipsis-h" aria-hidden="true"></i>
                                 </a>
                                 <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="#"><i class="fas fa-fw fa-star"></i> &nbsp; Top Rated</a>
                                    <a class="dropdown-item" href="#"><i class="fas fa-fw fa-signal"></i> &nbsp; Viewed</a>
                                    <a class="dropdown-item" href="#"><i class="fas fa-fw fa-times-circle"></i> &nbsp; Close</a>
                                 </div>
                              </div>
                              <h6>Live Now</h6>
                           </div>
                        </div>
                        <div class="col-md-12">
                           <div class="owl-carousel owl-carousel-category">                           
                              <% liveStreamer.forEach(streamer => { %>
                                 
                                 <div class="item">
                                    <div class="category-item">
                                       <a href="/<%= streamer.username %>">
                                          <img class="img-fluid" src="/assets/img/s1.png" alt="">
                                          <h6><%= streamer.username %> </h6>
                                          <p><%= streamer.totalViews %> views</p>
                                       </a>
                                    </div>
                                 </div>
                              <% }); %> 
                           </div>
                        </div>
                     </div>
                  <% } %>  
               </div>
               
               <hr class="mt-0">
               <div class="video-block section-padding">
                  <div class="row">
                     <div class="col-md-12">
                        <div class="main-title">
                           <div class="btn-group float-right right-action">
                              <a href="#" class="right-action-link text-gray" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              Sort by <i class="fa fa-caret-down" aria-hidden="true"></i>
                              </a>
                              <div class="dropdown-menu dropdown-menu-right">
                                 <a class="dropdown-item" href="#"><i class="fas fa-fw fa-star"></i> &nbsp; Top Rated</a>
                                 <a class="dropdown-item" href="#"><i class="fas fa-fw fa-signal"></i> &nbsp; Viewed</a>
                                 <a class="dropdown-item" href="#"><i class="fas fa-fw fa-times-circle"></i> &nbsp; Close</a>
                              </div>
                           </div>
                           <h6>Popular Channels</h6>
                        </div>
                     </div>
                        <% for(i=0; i < channelList.length; i++){ %>
                           <div class="col-xl-3 col-sm-6 mb-3">
                              <div class="channels-card">
                                 <form id="subscribe">
                                    <div class="channels-card-image">
                                       <a href="/individual/<%= channelList[i].username %>"><img class="img-fluid" src="/assets/img/s2.png" alt=""></a>
                                       <input type="hidden" class="subscribed">
                                       <div class="channels-card-image-btn">
                                          <input type="hidden" class="subscribed">
                                          <a onclick="subscribe(<%= i %>)" class="btn btn-outline-danger btn-sm el">
                                             <% var issub = false %>
                                             <% for( let j = 0; j < subscribersList.length; j++ ) { %>
                                                <% if(subscribersList[j].channel == channelList[i].username){ %>
                                                   <% issub = true %>
                                                <% } %>
                                             <% } %>
                                             <% if(issub == true){ %>
                                                <strong>Unsubscribe</strong>
                                             <% }else{ %>
                                                <strong>Subscribe</strong>
                                             <% } %> 
                                          </a>
                                       </div>                                       
                                    </div>
                                    <div class="channels-card-body">
                                          <div class="channels-title">
                                             <a href="/individual/<%= channelList[i].username %>"><%= channelList[i].username %></a>
                                             <input type="hidden" value="<%= channelList[i].username %>" class="channel">
                                          </div>
                                          <div class="channels-view">
                                             <% count.forEach((group) => { %>
                                                <% if(group._id == channelList[i].username){ %>
                                                   <%= group.count %> subscribers
                                                <% } %>  
                                             <% }) %>
                                          </div>
                                    </div>
                                 </form>
                              </div>
                           </div>
                        <% } %>
                  </div>
               </div>
            </div>
            <!-- /.container-fluid -->
            
         </div>
         <!-- /.content-wrapper -->
      </div>
      <!-- /#wrapper -->
      <!-- Scroll to Top Button-->
      <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
      </a>
      <!-- Logout Modal-->
      <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                  <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                  </button>
               </div>
               <div class="modal-body">Select "Logout" below if you want to leave ?</div>
               <div class="modal-footer">
                  <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                  <a class="btn btn-primary" href="/logout"">Logout</a>
               </div>
            </div>
         </div>
      </div>
      <!-- Bootstrap core JavaScript-->
      <script src="/assets/vendor/jquery/jquery.min.js"></script>
      <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
      <!-- Core plugin JavaScript-->
      <script src="/assets/vendor/jquery-easing/jquery.easing.min.js"></script>
      <!-- Owl Carousel -->
      <script src="/assets/vendor/owl-carousel/owl.carousel.js"></script>
      <!-- Custom scripts for all pages-->
      <script src="/assets/js/custom.js"></script>
   </body>

</html>
<script>
   var channelview = document.getElementsByClassName('channels-view')
   for(i=0; i<channelview.length; i++){
      if(channelview[i].innerText == ''){
         channelview[i].innerText = "0 subscriber";
      }
   };
   var notification = document.getElementById('notification');
   var notificationCount = document.getElementById('notificationCount');
   var removeNotification = function(el){
      var str = el.getElementsByTagName('span')[0].innerText;
      var broadcaster = str.split(" ")[0];
      notification.removeChild(el);
      $.ajax({
         type: "POST",
         url: "/notification",
         data: {broadcaster: broadcaster},
         success: function(){
            window.location.href = window.location.origin+'/'+broadcaster;
         }
      });
   }
   $( document ).ready(function() {      
      var checkNotification = function(){
         var streamerList = [];
         $.ajax({
            type: "GET",
            url: "/notification",
            success: function(data){
               notification.innerHTML = '';

               data.forEach(newData => {
                  var bc = newData.broadcaster
                  var a = document.createElement('a');
                  var i = document.createElement('i');
                  var span = document.createElement('span');
                  
                  a.className = 'dropdown-item';
                  i.className = 'fas fa-stream';
                  a.appendChild(i);
                  a.setAttribute("onclick", "removeNotification(this)");
                  span.innerText = newData.broadcaster + ' has started streaming';
                  a.appendChild(span);
                  
                  span.className = "ml-2"
                  
                  notification.prepend(a);
                  streamerList.push(newData);
               });
               if (streamerList.length > 0){
                  notificationCount.innerText = streamerList.length;
               }
               else{
                  notificationCount.innerText = '';
               }
            },
            error: function(error){
               console.log(error);
            }
         });
      };
      setInterval(checkNotification, 1000);
   })
   
   function subscribe(index){
      var subscribed = document.getElementsByClassName('subscribed');
      var channel = document.getElementsByClassName("channel");
      var el = document.getElementsByClassName('el')[index];
      if(el.innerText == 'Subscribe'){
         subscribed[index].value = "yes"
      }
      else{
         subscribed[index].value = "no"
      }
      $.ajax({
         type: "POST",
         url: "/",
         data: {channel: channel[index].value, subscribed: subscribed[index].value},
         success: function(){
            location.reload();
         }
      });
   }
   
</script>
<% } %>
