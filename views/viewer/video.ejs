<!DOCTYPE html>
<html lang="en">
   
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="Askbootstrap">
		<meta name="author" content="Askbootstrap">
		<title>VIDOE - Video Streaming Website HTML Template</title>
		<!-- Favicon Icon -->
		<link rel="icon" type="image/png" href="img/favicon.png">
		<!-- Bootstrap core CSS-->
		<link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<!-- Custom fonts for this template-->
		<link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
		<!-- Custom styles for this template-->
		<link href="/assets/css/osahan.css" rel="stylesheet">
		<!-- Owl Carousel -->
		<link rel="stylesheet" href="/assets/vendor/owl-carousel/owl.carousel.css">
        <link rel="stylesheet" href="/assets/vendor/owl-carousel/owl.theme.css">
        
        <link href="/assets/css/style.css" rel="stylesheet">
   	</head>
   	<body id="page-top">
		<%- include ('partials/navbar.ejs') %>
      	<div id="wrapper">
        	<!-- Sidebar -->
			<ul class="sidebar navbar-nav">
				<li class="nav-item active">
					<a class="nav-link" href="/">
						<i class="fas fa-fw fa-home"></i>
						<span>Home</span>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/channels">
						<i class="fas fa-fw fa-users"></i>
						<span>Subscriptions</span>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/account">
						<i class="fas fa-fw fa-user"></i>
						<span>My Account</span>
					</a>
				</li>
				
				<li class="nav-item channel-sidebar-list">
					<h6>SUBSCRIPTIONS</h6>
					<ul> 
					   <% for( let i = 0; i < subscribersList.length; i++ ) { %>
						  <li>
							 <a href="/individual/<%= subscribersList[i].channel %>">
								<% channelList.forEach((group) => { %>
								   <% if(group.username == subscribersList[i].channel){ %>
									  <% if (group.image == undefined) { %>
										 <img class="img-fluid" alt="" src="uploads/user.png">
									  <% }else{ %>
										 <img class="img-fluid" alt="" src="<%= group.image %>">
									  <% } %>
								   <% } %>  
								<% }) %>
								<%= subscribersList[i].channel %>  
							 </a>
						  </li>
					   <% } %>
					</ul>
				</li>
			</ul>
		 
			<div id="content-wrapper">
				<div class="container-fluid pb-0">
					<div class="video-block section-padding">
						<div class="row">

							<!-- Center -->
							<div class="col-md-8">
								<div class="single-video-left">
									<div class="single-video">
										<!---------------------------------->
										<!---------------------------------->
										<!---------------------------------->
										<!---------------------------------->
										<!---------------------------------->
										<!---------------------------------->
										<video style="width: 100%; height: 100%;" autoplay playsinline controls></video>
									</div>
									<div class="single-video-title box mb-3">
										<h2><%= video.title %></h2>
										<p class="mb-0"><i class="fas fa-eye"></i> <%= broadcaster.viewsCount %> views</p>
									</div>
									<div class="desc1">
										<div class="single-video-author box mb-3">
											<div class="float-right">
												<button class="btn btn-danger" onclick="subscribe(this, '<%= username %>')" type="button">
													<% if(subs){ %>
														Unsubscribe
													<% }else{ %>
														Subscribe
													<% } %>
												</button>
											</div>
											<img class="img-fluid" src="/assets/img/s4.png" alt="">
											<p><a href="#"><strong><%= username %></strong></a> <span title="" data-placement="top" data-toggle="tooltip" data-original-title="Verified"><i class="fas fa-check-circle text-success"></i></span></p>
											<small style="font-size: 0.9em;">Started Streaming <%= time %></small>
										</div>
										<div class="single-video-info-content box mb-3">
											<h6>Language:</h6>
											<p><%= video.language %></p>
											<h6>Category :</h6>
											<p><%= video.tags %></p>
											<h6>About :</h6>
											<p><%= video.description %></p>
										</div>
									</div>
								</div>
							</div>
							
							<!-- Right -->
							<div class="col-md-4 chat">
								<div class="bg-white shadow" id="chat-box" style="height: 350px; overflow-y: scroll;">
                                    <!-- <div>
										<div class="col-md-4 mt-2 py-2 text-center chat-user" style="float: left;">
											<span class="d-inline-block" tabindex="0" data-toggle="tooltip" title="Srijan">
												<img alt="Avatar" style="height: 30px; width: 30px; pointer-events: none;" src="/uploads\1588340002309-Screenshot_2020-05-01-00-34-17-304_com.instagram.android.jpg">
											</span>
										</div>
										<div class="col-md-7 bg-pri py-2 mt-2 chat-text" style="float: left;">
											Test, which is a new approach to have. Test, which is a new approach to have
										</div>
									</div>
									<div>
										<div class="col-md-4 mt-2 py-2 text-center chat-user" style="float: left;">
											<span class="d-inline-block" tabindex="0" data-toggle="tooltip" title="Srijan">
												<img alt="Avatar" style="height: 30px; width: 30px; pointer-events: none;" src="/uploads\1588340002309-Screenshot_2020-05-01-00-34-17-304_com.instagram.android.jpg">
											</span>
										</div>
										<div class="col-md-7 bg-lig py-2 mt-2 mychat-text" style="float: left;">
											Test, which is a new approach to haveTest, which is a new approach to have
										</div>
									</div>									 -->
								</div>
								
								<div class="row pt-1 px-3">
									<input class="col-md-9 form-control" id="chat">
									<button class="col-md-3 btn btn-success" onclick="sendMessage()">Send</button>
								</div>
							</div>

							<div class="col-md-8">
								<div class="single-video-left">
									<div class="desc2 mt-5">
										<div class="single-video-author box mb-3">
											<div class="float-right">
												<button class="btn btn-danger" onclick="subscribe(this, '<%= username %>')" type="button">
													<% if(subs){ %>
														Unsubscribe
													<% }else{ %>
														Subscribe
													<% } %>
												</button>
											</div>
											<img class="img-fluid" src="/assets/img/s4.png" alt="">
											<p><a href="#"><strong><%= username %></strong></a> <span title="" data-placement="top" data-toggle="tooltip" data-original-title="Verified"><i class="fas fa-check-circle text-success"></i></span></p>
											<small style="font-size: 0.9em;">Started Streaming <%= time %></small>
										</div>
										<div class="single-video-info-content box mb-3">
											<h6>Language:</h6>
											<p><%= video.language %></p>
											<h6>Category :</h6>
											<p><%= video.tags %></p>
											<h6>About :</h6>
											<p><%= video.description %></p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>

				
				<!-- /.container-fluid -->
				<!-- Sticky Footer -->
			</div>
        <!-- /.content-wrapper -->
      	</div>
		<!-- /#wrapper -->
		<!-- Scroll to Top Button-->
		<a class="scroll-to-top rounded" href="#page-top">
		<i class="fas fa-angle-up"></i>
		</a>
		<!-- Logout Modal-->
		<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-sm modal-dialog-centered" role="document">
				<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
					<button class="close" type="button" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">Ã—</span>
					</button>
				</div>
				<div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
					<a class="btn btn-primary" href="/logout">Logout</a>
				</div>
				</div>
			</div>
		</div>

		<!-- Modal -->
		<!-- Bootstrap core JavaScript-->
		<script src="/assets/vendor/jquery/jquery.min.js"></script>
		<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
		<!-- Core plugin JavaScript-->
		<script src="/assets/vendor/jquery-easing/jquery.easing.min.js"></script>
		<!-- Owl Carousel -->
		<script src="/assets/vendor/owl-carousel/owl.carousel.js"></script>
		<!-- Custom scripts for all pages-->
		<script src="/assets/js/custom.js"></script>
	</body>

</html>


<script src="/socket.io/socket.io.js"></script>
<script>
	const socket = io.connect(window.location.origin);
	var viewer = document.getElementById('viewer').innerText;
	
	var chatbox = document.getElementById('chat-box')
	var username = window.location.pathname.split("/")[1];
	const video = document.querySelector('video');
	let socketid;
</script>

<script>
	/*global socket, video, config*/
	let peerConnection;

	socket.on('offer', function(id, description, data) {
		if(data.name == username){
			socketid = id;
			peerConnection = new RTCPeerConnection();
			peerConnection.setRemoteDescription(description)
			.then(() => peerConnection.createAnswer())
			.then(sdp => peerConnection.setLocalDescription(sdp))
			.then(function () {
				socket.emit('answer', id, peerConnection.localDescription);
			});
			peerConnection.ontrack = function(event) {
				video.srcObject = event.streams[0];
			};
			peerConnection.onicecandidate = function(event) {
				if (event.candidate) {
					socket.emit('candidate', id, event.candidate);
				}
			};
		}
	});

	socket.on('candidate', function(id, candidate) {
		peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
		.catch(e => console.error(e));
	});

	socket.on('connect', function() {
		socket.emit('watcher', username, viewer);
	});

	socket.on('broadcaster', function() {
		socket.emit('watcher', username, viewer);
	});

	socket.on('bye', function() {
		peerConnection.close();
	});

	function sendMessage(){
		var el = document.createElement("div");
		var user = document.createElement("div");
		var userMsg = document.createElement("div");
		var userimg = document.createElement("img");
		
		user.className = 'col-md-4 mt-2 py-2 text-center chat-user';

		var spantext = document.createElement("span");
		spantext.className = 'd-inline-block'; 
		spantext.setAttribute('tabindex', '0');
		spantext.setAttribute('data-toggle', 'data-toggle');
		spantext.setAttribute('title', viewer);
		userimg.setAttribute('style', 'height: 24px; width: 24px; pointer-events: none;');
		$.ajax({
			type: "POST",
			url: "/user/image",
			data: {username: viewer},
			success: function(res){
				userimg.setAttribute('src', '/'+res.image);
			}
		});
		user.style.float = 'left';

		userMsg.className = 'mb-2 col-sm-4 col-md-7 bg-lig py-2 mt-2 mb-2 chat-text';
		userMsg.innerText = document.getElementById('chat').value;
		socket.emit('chat', document.getElementById('chat').value, username, viewer);
		document.getElementById('chat').value = "";
		userMsg.style.float = 'left';
		
		chatbox.appendChild(el);
		el.appendChild(user);
		el.appendChild(userMsg);
		user.appendChild(spantext);
		spantext.appendChild(userimg);
		document.getElementById('chat-box').scrollTop = 9999999;
	}

	socket.on('chater', function(msg, viewer){
		var el = document.createElement("div");
		var user = document.createElement("div");
		var userMsg = document.createElement("div");
		var userimg = document.createElement("img");
		
		user.className = 'col-md-4 mt-2 py-2 text-center chat-user';

		var spantext = document.createElement("span");
		spantext.className = 'd-inline-block'; 
		spantext.setAttribute('tabindex', '0');
		spantext.setAttribute('data-toggle', 'tooltip');
		spantext.setAttribute('title', viewer);
		userimg.setAttribute('style', 'height: 24px; width: 24px; pointer-events: none;');
		$.ajax({
			type: "POST",
			url: "/user/image",
			data: {username: viewer},
			success: function(res){
				userimg.setAttribute('src', '/'+res.image);
			}
		});
		user.style.float = 'left';

		userMsg.className = 'mb-2 col-sm-4 col-md-7 bg-pri py-2 mt-2 mb-2 chat-text';
		userMsg.innerText = msg;
		userMsg.style.float = 'left';
		
		chatbox.appendChild(el);
		el.appendChild(user);
		el.appendChild(userMsg);
		user.appendChild(spantext);
		spantext.appendChild(userimg);
		document.getElementById('chat-box').scrollTop = 9999999;
		
	});

	function subscribe(el, channel){
		var subscribed = "no"
		if(el.innerText == 'Subscribe'){
			subscribed = "yes"
		}
		$.ajax({
			type: "POST",
			url: "/",
			data: {channel: channel, subscribed: subscribed},
			success: function(){
				location.reload();
			}
		});
	}
	var notification = document.getElementById('notification');
	var notificationCount = document.getElementById('notificationCount');
	var removeNotification = function(el){
		var str = el.getElementsByTagName('span')[0].innerText;
		var broadcaster = str.split(" ")[0];
		notification.removeChild(el);
		$.ajax({
		type: "POST",
		url: "/notification",
		data: {broadcaster: broadcaster},
		success: function(){
			window.location.href = window.location.origin+'/'+broadcaster;
		}
		});
	}
	$( document ).ready(function() {      
		var checkNotification = function(){
			var streamerList = [];
			$.ajax({
				type: "GET",
				url: "/notification",
				success: function(data){
					notification.innerHTML = ''
					data.forEach(newData => {
						var bc = newData.broadcaster
						var a = document.createElement('a');
						var i = document.createElement('i');
						var span = document.createElement('span');
						
						a.className = 'dropdown-item';
						i.className = 'fas fa-stream';
						a.appendChild(i);
						a.setAttribute("onclick", "removeNotification(this)");
						span.innerText = newData.broadcaster + ' has started streaming';
						a.appendChild(span);
						
						span.className = "ml-2"
						
						notification.prepend(a);
						streamerList.push(newData);
					});
					if (streamerList.length > 0){
						notificationCount.innerText = streamerList.length;
					}
					else{
						notificationCount.innerText = '';
					}
				},
				error: function(error){
					console.log(error);
				}
			});
		};
		var x = setInterval(checkIsStreaming, 1000);
		function checkIsStreaming(){
			$.ajax({
				type: "POST",
				url: "/isStreaming",
				data: {username: '<%= username %>'},
				success: function(res){
					if(res.isStreaming == false){
						var isStop = true;
						alert("Streamer has stopped streaming")
						clearInterval(x);
						window.location.reload();
					}
				}
			});
		}
		setInterval(checkNotification, 1000);
	});

</script>