<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Askbootstrap">
    <meta name="author" content="Askbootstrap">
    <title>VIDOE - Video Streaming Website HTML Template</title>
    <!-- Favicon Icon -->
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">
    <!-- Bootstrap core CSS-->
    <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom fonts for this template-->
    <link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <!-- Custom styles for this template-->
    <link href="/assets/css/osahan.css" rel="stylesheet">
    <!-- Owl Carousel -->
    <link rel="stylesheet" href="/assets/vendor/owl-carousel/owl.carousel.css">
    <link rel="stylesheet" href="/assets/vendor/owl-carousel/owl.theme.css">
 </head>
   <body id="page-top">
      <%- include('partials/navbar.ejs') %>
      <div id="wrapper">
      <!-- Sidebar -->
         <ul class="sidebar navbar-nav">
            <li class="nav-item">
               <a class="nav-link" href="/">
               <i class="fas fa-fw fa-home"></i>
               <span>Home</span>
               </a>
            </li>
            <li class="nav-item active">
               <a class="nav-link" href="/channels">
               <i class="fas fa-fw fa-users"></i>
               <span>Subscriptions</span>
               </a>
            </li>
            <li class="nav-item">
               <a class="nav-link" href="/account">
               <i class="fas fa-fw fa-user"></i>
               <span>My Account</span>
               </a>
            </li>
            <li class="nav-item channel-sidebar-list">
               <h6>SUBSCRIPTIONS</h6>
               <ul> 
                  <% for( let i = 0; i < subscribersList.length; i++ ) { %>
                     <li>
                        <a href="/individual/<%= subscribersList[i].channel %>">
                           <img class="img-fluid" alt="" src="/assets/img/s1.png">
                           <%= subscribersList[i].channel %>  
                        </a>
                     </li>
                  <% } %>
               </ul>
            </li>
         </ul>
      <div id="content-wrapper">
      <div class="container-fluid pb-0">
         <div class="video-block section-padding">
            <div class="row">
               <div class="col-md-12">
                  <div class="main-title">
                     <div class="btn-group float-right right-action">
                        <a href="#" class="right-action-link text-gray" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Sort by <i class="fa fa-caret-down" aria-hidden="true"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                           <a class="dropdown-item" href="#"><i class="fas fa-fw fa-star"></i> &nbsp; Top Rated</a>
                           <a class="dropdown-item" href="#"><i class="fas fa-fw fa-signal"></i> &nbsp; Viewed</a>
                           <a class="dropdown-item" href="#"><i class="fas fa-fw fa-times-circle"></i> &nbsp; Close</a>
                        </div>
                     </div>
                     <h6>Channels</h6>
                  </div>
               </div>
               <% for(i=0; i < result.length; i++){ %>
                  <div class="col-xl-3 col-sm-6 mb-3">
                     <div class="channels-card">
                        <form id="subscribe">
                           <div class="channels-card-image">
                              <a href="/individual/<%= result[i]._id %>"><img class="img-fluid" src="/assets/img/s2.png" alt=""></a>
                              <input type="hidden" class="subscribed">
                              <div class="channels-card-image-btn">
                                 <input type="hidden" class="subscribed">
                                 <a onclick="subscribe(<%= i %>)" class="btn btn-outline-danger btn-sm el">
                                    <strong>Unsubscribe</strong>   
                                 </a>
                              </div>                                       
                           </div>
                           <div class="channels-card-body">
                                 <div class="channels-title">
                                    <a href="/individual/<%= result[i]._id %>"><%= result[i]._id %></a>
                                    <input type="hidden" value="<%= result[i]._id %>" class="channel">
                                 </div>
                                 <div class="channels-view">
                                    <%= result[i].count %> subscribers
                                 </div>
                           </div>
                        </form>
                     </div>
                  </div>
               <% } %>
            </div>
         </div>
         <hr>
      </div>
      <!-- /.container-fluid -->
      <!-- Sticky Footer -->
   </div>
   <!-- /.content-wrapper -->
      </div>
  <!-- /#wrapper -->
  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
  </a>
  <!-- Logout Modal-->
  <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
     <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
           <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
              <button class="close" type="button" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">Ã—</span>
              </button>
           </div>
           <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
           <div class="modal-footer">
              <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
              <a class="btn btn-primary" href="/logout">Logout</a>
           </div>
        </div>
     </div>
  </div>
  <!-- Bootstrap core JavaScript-->
  <script src="/assets/vendor/jquery/jquery.min.js"></script>
   <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
   <!-- Core plugin JavaScript-->
   <script src="/assets/vendor/jquery-easing/jquery.easing.min.js"></script>
   <!-- Owl Carousel -->
   <script src="/assets/vendor/owl-carousel/owl.carousel.js"></script>
   <!-- Custom scripts for all pages-->
   <script src="/assets/js/custom.js"></script>
   <script>
      function subscribe(index){
         var subscribed = document.getElementsByClassName('subscribed');
         var channel = document.getElementsByClassName("channel");
   
         subscribed[index].value = "no"
         $.ajax({
            type: "POST",
            url: "/",
            data: {channel: channel[index].value, subscribed: subscribed[index].value},
            success: function(){
               location.reload();
            }
         });
      }
      var notification = document.getElementById('notification');
      var notificationCount = document.getElementById('notificationCount');
      var removeNotification = function(el){
         var str = el.getElementsByTagName('span')[0].innerText;
         var broadcaster = str.split(" ")[0];
         notification.removeChild(el);
         $.ajax({
            type: "POST",
            url: "/notification",
            data: {broadcaster: broadcaster},
            success: function(){
               window.location.href = window.location.origin+'/'+broadcaster;
            }
         });
      }
      $( document ).ready(function() {      
         var checkNotification = function(){
            var streamerList = [];
            $.ajax({
               type: "GET",
               url: "/notification",
               success: function(data){
                  console.log(data)
                  notification.innerHTML = ''
                  data.forEach(newData => {
                     var bc = newData.broadcaster
                     var a = document.createElement('a');
                     var i = document.createElement('i');
                     var span = document.createElement('span');
                     
                     a.className = 'dropdown-item';
                     i.className = 'fas fa-stream';
                     a.appendChild(i);
                     a.setAttribute("onclick", "removeNotification(this)");
                     span.innerText = newData.broadcaster + ' has started streaming';
                     a.appendChild(span);
                     
                     span.className = "ml-2"
                     
                     notification.prepend(a);
                     streamerList.push(newData);
                  });
                  if (streamerList.length > 0){
                     notificationCount.innerText = streamerList.length;
                  }
                  else{
                     notificationCount.innerText = '';
                  }
               },
               error: function(error){
                  console.log(error);
               }
            });
         };
         setInterval(checkNotification, 1000);
      });
   </script>
 </body>